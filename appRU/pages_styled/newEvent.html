<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>
    <div style="margin-top: 30px; height: 100px;" id='signout_button' class="logout"><a href="../ajax/logout.php">Выйти</a></div>

    <button id="createEvent">Create event</button>

    <input id='eventID' type="text">

    <button id="updateEvent">Update event</button>
    <button id="deleteEvent">Delete event</button>

    <script src="//code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
    <script>
        // Client ID and API key from the Developer Console
        var CLIENT_ID = '';
        var API_KEY = '';
        // Array of API discovery doc URLs for APIs used by the quickstart
        var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];
        // Authorization scopes required by the API; multiple scopes can be
        // included, separated by spaces.
        var SCOPES = "https://www.googleapis.com/auth/calendar";


        var signoutButton = document.getElementById('signout_button');


        /**
         *  On load, called to load the auth2 library and API client library.
         */
        function handleClientLoad() {
            gapi.load('client:auth2', initClient);
        }
        /**
         *  Initializes the API client library and sets up sign-in state
         *  listeners.
         */
        function initClient() {
            gapi.client.init({
                apiKey: API_KEY,
                clientId: CLIENT_ID,
                discoveryDocs: DISCOVERY_DOCS,
                scope: SCOPES
            }).then(function () {
                // Listen for sign-in state changes.
                gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
                // Handle the initial sign-in state.
                updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
                signoutButton.onclick = handleSignoutClick;



            }, function (error) {
                appendPre(JSON.stringify(error, null, 2));
            });
        }

        /**
         *  Called when the signed in status changes, to update the UI
         *  appropriately. After a sign-in, the API is called.
         */
        function updateSigninStatus(isSignedIn) {
            console.log('updateSigninStatus');

        }

        /**
         *  Sign out the user upon button click.
         */
        function handleSignoutClick(event) {
            gapi.auth2.getAuthInstance().signOut();
        }
        /**
         * Append a pre element to the body containing the given message
         * as its text node. Used to display the results of the API call.
         *
         * @param {string} message Text to be placed in pre element.
         */
        function appendPre(message, id) {
            // var pre = document.getElementById('content');
            // var textContent = document.createTextNode(message + '\n');
            // pre.appendChild(textContent);
            console.log(message + '\n');
            $("#eventID").val(id);

        }

        // call as ajax
        function newEvent(startDate,startTime,endTime) {

            // Refer to the JavaScript quickstart on how to setup the environment:
            // https://developers.google.com/calendar/quickstart/js
            // Change the scope to 'https://www.googleapis.com/auth/calendar' and delete any
            // stored credentials.

            var event = {
                'summary': 'Program Name',
                'location': 'location',
                'description': 'Short description for program',
                'start': {
                    // dateTime = day of week of program ->find when is next date
                    // concat date and time from function input startDate startTime
                    'dateTime': '2019-01-08T09:00:00',
                    'timeZone': 'Europe/Moscow'
                },
                'end': {
                    // end date same as start date
                    // concat date and time from function input endTime
                    'dateTime': '2019-01-08T17:00:00',
                    'timeZone': 'Europe/Moscow'
                },
                'recurrence': [
                    'RRULE:FREQ=WEEKLY;BYDAY=WE'
                ],
                'reminders': {
                    "useDefault": false,
                    "overrides": [{
                        "method": "popup",
                        "minutes": 120
                    }]
                }
            };

            var request = gapi.client.calendar.events.insert({
                'calendarId': 'primary',
                'resource': event
            });

            request.execute(function (event) {
                appendPre('Event created: ' + event.htmlLink, event.id);
            });

        }

        function updateEvent() {
            var eventID = $("#eventID").val();
            var event = gapi.client.calendar.events.get({
                "calendarId": 'primary',
                "eventId": eventID
            });

            // Example showing a change in the location
            event.location = "New Address";

            var request = gapi.client.calendar.events.patch({
                'calendarId': 'primary',
                'eventId': eventID,
                'resource': event
            });

            request.execute(function (event) {
                console.log(event);
            });
        }

        function deleteEvent() {


            var eventID = $("#eventID").val();



            var request = gapi.client.calendar.events.delete({
                calendarId: 'primary',
                eventId: eventID
            });

            request.execute();

        }

        $('#createEvent').click(newEvent);
        $('#updateEvent').click(updateEvent);
        $('#deleteEvent').click(deleteEvent);
    </script>

    <script async defer src="https://apis.google.com/js/api.js" onload="this.onload=function(){};handleClientLoad()"
        onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>
    <script>
        /**
        *   Get the start date for group event BEGINS
        */
        // воскресеньям - 0
        // понедельникам - 1
        // вторникам - 2
        // средам - 3
        // четвергам - 4
        // пятницам - 5
        // субботам - 6
        
        var programDay;
        switch (new Date().getDay()) {
            case 0:
                programDay = "6";
                break;
            case 1:
                programDay = "0";
                break;
            case 2:
                programDay = "1";
                break;
            case 3:
                programDay = "2";
                break;
            case 4:
                programDay = "3";
                break;
            case 5:
                programDay = "4";
                break;
            case 6:
                programDay = "5";
        }

        // get program dayOfWeek
        // if today date dayofweek = programdayofweek
        // pass today as starting date in google events
        // if not call getNextDayOfWeek passing today date and program's dayofweek
        // then pass nextOccurence as starting date in google events


        function getNextDayOfWeek(date, dayOfWeek) {
            console.log(dayOfWeek);
            
            // Code to check that date and dayOfWeek are valid left as an exercise ;)
            var resultDate = new Date(date.getTime());
            resultDate.setDate(date.getDate() + (7 + dayOfWeek - date.getDay()) % 7);
            return resultDate;
        }
        var today = new Date();
        var nextOccurence = getNextDayOfWeek(today, programDay);
        console.log(nextOccurence);
        /**
        *   Get the start date for group event ENDS
        */
    </script>
</body>

</html>